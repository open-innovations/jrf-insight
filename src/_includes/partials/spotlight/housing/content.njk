{% set geo = geography %}
{% set ct_pensioners = this_place_data['council_tax_pensioners'] %}
{% set ct_working_age = this_place_data['council_tax_working_age'] %}
{% set ct_pensioners_ratio = (this_place_data['council_tax_pensioners'] / this_place_data['number_of_pensioners']) %}
{% set ct_working_age_ratio = (this_place_data['council_tax_working_age'] / this_place_data['number_of_working_age']) %}

{% set smi_loans_in_payment_households = this_place_data['smi_loans_in_payment_households'] %}

{% set homeless = this_place_data['Total households assessed as owed a duty'] %}
{% set homeless_ratio = (this_place_data['Total households assessed as owed a duty'] / this_place_data['Number of households']) %}

{% set housing_benefit = this_place_data['HB_claimants'] %}
{% set number_of_households = this_place_data['Number of households'] %}
{% set housing_benefit_percent = (100*this_place_data['HB_claimants'] / this_place_data['Number of households']) | round(1) %}
{% set house_prices = this_place_data['Median house price'] %}
{% set place_children = place[geography].relations.children %}

<p>ADD MODEL IN HERE...</p>

<h3>Key indicators</h3>

<p>The following analysis reflects the experience across the population of {{ this_place.title }}.</p>

{% comp 'layout.tab.set' %}

  {% comp 'layout.tab.panel', { label: 'LHA shortfall', id: 'lha-shortfall' } %}
    {% set chart_data = dataset.housing_allowance.shortfall_for_geo(geo) %}
    <h3>
      Local Housing Allowance shortfall
    </h3>
    {% if chart_data | length > 0 %}
      {% comp 'layout.wrapper', { width: 'max(20em, 70%)' } %}
      {{ 
        comp.oi.chart.bar({
          config: {
            data: chart_data,
            category: "property_name",
            padding: { left: 50, bottom: 50 },
            columns: [
              {
                name: 'tooltip',
                template: '£{{ LHA_shortfall | toFixed(0) | toLocaleString() }} for {{ property_name }} rentals.'
              }
            ],
            axis: {
              x: {
                title: { label: 'Difference between 30th percentile rental and LHA (£)' },
                tick: { spacing: 50 }
              },
              y: {
                title: { label: 'Size of property' }
              }
            },
            series: [
              { title: this_place.title, value: "LHA_shortfall", tooltip: "tooltip" }
            ]
          }
        })
      | safe }}
      {% endcomp %}
    {% else %}
      <p> 
        There is currently no data for LHA shortfall at {{ this_place.title }}.
      </p>
    {% endif %}

    {% comp 'collapse', { heading: "What's on this chart?" } %}
      <p>
        LHA used to be benchmarked to the the 30th percentile of rental prices but
        has been frozen in cash terms since April 2020.
        As a result LHA now lags the rental prices in some areas.
      </p>
    {% endcomp %}
  {% endcomp %}

  {% comp 'layout.tab.panel', { label: 'House prices', id: 'house-prices' } %}
    {% set chart_data = data.spotlight.housing.time_series.getHousePrices(geo) %}
    <h3>Median house prices</h3>
    {% comp 'collapse', { heading: "What's on this chart?"} %}
      <p>This chart shows median house prices over time in {{ this_place.title }}.</p>
      <h4>Dataset</h4> {{ comp.sourcelink({dataset: "house-prices", view: "house-prices"}) | safe }}
    {% endcomp %}
    {% if chart_data.rows | length > 0 %}
      {% comp 'layout.wrapper', { width: 'max(20em, 70%)' } %}
        {{ comp.oi.chart.line({
            config: {
              legend: { 
                show: true
              },
              data: chart_data,
              padding: { bottom: 20, left: 20},
              axis: {
                x: {
                  title: {
                    label: "Year"
                  }
                },
                y: {
                  title: {
                    label: "Median House Prices (£)"
                  },
                  grid: {
                    show: true
                  },
                  ticks: [
                    { label: '350k', value: 350000 },
                    { label: '300k', value: 300000 },
                    { label: '250k', value: 250000 },
                    { label: '200k', value: 200000 },
                    { label: '150k', value: 150000 },
                    { label: '150k', value: 100000 },
                    { label: '50k', value: 50000 },
                    { label: '0', value: 0 }
                    ],
                  min: 0,
                  max: 350000 
                }
              },
              series: [
                {
                  title: this_place_data.name,
                  x: "date",
                  y: "value",
                  colour: "#13242F",
                  line: {
                    "stroke-dasharray": "0 10"
                  }
                }
              ]
            }
          })| safe
        }}
      {% endcomp %}
    {% else %}
      <p>No data available at this level</p>
    {%  endif %}
  {% endcomp %}

  {% comp 'layout.tab.panel', { label: 'Current rental prices', id: 'rental-prices' } %}
    {# 
        Social rented sector rent levels and rent increase (Regulator of Social Housing) 
        Private rented sector rent levels and rental growth (ONS, Rightmove & Zoopla)
    #}
    <h3>Current median rental prices by type of property</h3>
    {% comp 'collapse', { heading: "What's on this chart?"} %}
      <p>This chart shows current median rental prices by type of property in {{ this_place.title }}.</p>
      <h4>Dataset</h4> {{ comp.sourcelink({dataset: "rental-prices", view: "rental-prices.csv"}) | safe }}
    {% endcomp %}
    {% set chart_data = data.spotlight.housing.bar_charts.current_rental_prices_for_place(geo) %}
    {% if chart_data.rows | length > 0 %}
      {% comp 'layout.wrapper', { width: 'max(20em, 70%)' } %}
        {{comp.oi.chart.bar({
          config: {
            data: data.spotlight.housing.bar_charts.current_rental_prices_for_place(geo),
            stacked: false,
            legend: { 
              show: true
            },
            category: "property_code",
            series: [
              {
              "title": this_place_data.name,  
              "value": geo,
              "colour": "#64A70B"
              }
            ], 
            axis: {
              x: {
                tick: {
                  spacing: 400
                  }
                }
              }
            }
            }) | safe
          }}
        {% endcomp %}
    {% else %}
    <p>No data available at this level.</p>
    {% endif %}
  {% endcomp %}


  {% comp 'layout.tab.panel', { label: 'Effect of housing costs', id: 'bhc-ahc' } %}
    {#
      Both BHC (before housing costs) and AHC (after housing costs) poverty rates
      - bigger the gap between the two, the larger the implied effect of housing costs in poverty rates
    #}
    <h3>Tenure type and poverty rates</h3>
    {% comp 'collapse', { heading: "What's on this chart?"} %}
      <p>This chart shows the poverty rates by type of tenure in {{ this_place.title }}, both before and after housing costs.
        The threshold for low income poverty is households below 60% of median net household income in latest prices.
      </p>
      <h4>Dataset</h4> {{ comp.sourcelink({dataset: "hbai", view: "by_tenure_type"}) | safe }}
    {% endcomp %}
    {% set chart_data = dataset.hbai.effect_of_house_prices_tenure(geo) %}
    {% if chart_data | length > 0 %}
      {% comp 'layout.wrapper', { width: 'max(20em, 70%)' } %}
        {{comp.oi.chart.bar({
          config: {
            data: chart_data,
            category: "Tenure Type of the Household of the Individual",
            series: [
              {
                title: "In poverty both before and after housing costs",
                value: "percent_ahc_and_bhc",
                tooltip: "Both before and after housing costs\n{{ Tenure Type of the Household of the Individual }}: {{ percent_ahc_and_bhc }}%",
                colour: "#8024c3"
              },
              {
                title: "In poverty after housing costs only",
                value: "percent_ahc_only",
                tooltip: "After housing costs only\n{{ Tenure Type of the Household of the Individual }}: {{ percent_ahc_only }}%",
                colour: "#64A70B"
              }
            ],
            axis: { 
              x: { 
                max: 50,
                tick: { 
                  spacing: 10 }, 
                grid: { 
                  "stroke-dasharray": "6 2", 
                  "stroke-width": 1 },
                ticks: [
                  { value: 10, label: '10%'},
                  { value: 20, label: '20%'},
                  { value: 30, label: '30%'},
                  { value: 40, label: '40%'},
                  { value: 50, label: '50%'}
                  ] 
                } 
              },
            stacked: true,
            legend: { show: true }
          }
        }) | safe
        }}
      {% endcomp %}
    {% else %}
      <p>No data available at this level.</p>
    {% endif %}
  {% endcomp %}

  {% comp 'layout.tab.panel', { label: 'Tenure type', id: 'tenure-type' } %}
    <h3>Poverty rates by tenure type (AHC)</h3>
    {% comp 'collapse', { heading: "What's on this chart?"} %}
      <p>This chart shows the poverty rates by type of tenure in {{ this_place.title }}.
        The threshold for low income poverty is households below 60% of median net household income (after housing costs) in latest prices.
      </p>
      <h4>Dataset</h4> {{ comp.sourcelink({dataset: "hbai", view: "by_tenure_type"}) | safe }}
      <p>Things to add: Current and historic tenure mix - drawing on census data
      - Social housing sales - RTB
      - completions of new homes relative to existing stock <p/>
    {% endcomp %}
    {% set chart_data = dataset.hbai.low_income_tenure_type(geo) %}
    {% if chart_data | length > 0 %}
      {% comp 'layout.wrapper', { width: 'max(20em, 70%)' } %}
        {{ comp.oi.chart.line({
            config: {
              legend: { 
                show: true
              },
              data: chart_data,
              padding: { left: 20, bottom: 20},
              axis: {
                x: {
                  title: {
                    label: "Year"
                  },
                  ticks: [
                  { value: "0", label: "1994-95 - 1996-97", tickSize: 8 },
                  { value: "8", label: "2002-03 - 2004-05", tickSize: 8 },
                  { value: "16", label: "2009-10 - 2011-12", tickSize: 8 },
                  { value: "24", label: "2017-18 - 2019-20", tickSize: 8 }
                  ]
                },
                y: {
                  title: {
                    label: "Low income poverty rate (%)"
                  },
                  grid: {
                    show: true
                  },
                  tick: {
                    spacing: 10
                  },
                  min: 0,
                  max: 50
                }
              },
              series: [
                {
                  title: "All rented privately",
                  x: "date",
                  y: "All rented privately",
                  colour: "#3EB1C8",
                  line: {
                    "stroke-dasharray": "0 10"
                  }
                },
                {
                  title: "Owned outright/buying with mortgage",
                  x: "date",
                  y: "Owned outright/buying with mortgage",
                  colour: "#8024c3",
                  line: {
                    "stroke-dasharray": "5 10"
                  }
                },
                {
                  title: "Social rented sector tenants",
                  x: "date",
                  y: "Social rented sector tenants",
                  colour: "#64A70B",
                  line: {
                    "stroke-dasharray": "3 9"
                  }
                }
              ]
            }
          })| safe }}
      {% endcomp %}
    {% else %}
      <p>No data available at this level.</p>
    {% endif %}
  {% endcomp %}

  {% comp 'layout.tab.panel', { label: 'Affordability', id: 'affordability'} %}
    <h3>Lower quartile rent to lower quartile earnings ratio</h3>
    {% comp 'collapse', { heading: "What's on this chart?"} %}
      <p>This chart shows the ratio of lower quartile rent for a 2 bedroom 
        property to lower quartile earnings across different areas in {{ this_place.title }}. 
        A higher value means the average person spends a larger proportion of their earnings on rent.
      </p>
      <h4>Dataset</h4> <ul><li>{{ comp.sourcelink({dataset: "rental-prices", view: "rental-prices"}) | safe }}</li>
      <li> {{ comp.sourcelink({dataset: "ashe", view: "weekly-earnings"}) | safe }} </li></ul>
    {% endcomp %}
    {% if place_children | length > 0 %}
      {% set chart_data = dataset.ashe.rent_to_earnings(place_children) %}
      {% if chart_data | length > 0 %}
        {% comp 'layout.wrapper', { width: 'min(20em, 70%)' } %}
        {{ comp.oi.map.svg({
          config: {
            data: chart_data,
            geojson: { data: place[geography].map, key: 'ons_code' },
            background: {
              geojson: 'map.england', colour: 'silver' },
            columns: [
              { name: 'tooltip', template: "{{ geography_name }}\n{{ value | toFixed(3) }}" }
            ],
            value: 'value',
            scale: 'Viridis',
            min: 0,
            max: 0.5,
            padding: 50,
            legend: {
              position: 'top',
              items: [
                { value: 0.5, label: '0.5 (high)' },
                { value: 0.25, label: '0.25' },
                { value: 0, label: '0 (low)' }
              ]
            },
            key: 'geography_code',
            tooltip: 'tooltip'
          }
        }) | safe }}
        {% endcomp %}
      {% else %}
        <p>No data available at this level.</p>
      {% endif %}
    {% endif %}
  {% endcomp %}

  {% comp 'layout.tab.panel', { label: 'Overcrowding', id: 'overcrowding' } %}
    Placeholder
  {% endcomp %}

  {% comp 'layout.tab.panel', { label: 'Housing insecurity', id: 'housing-insecurity' } %}
    {# 
      Numbers living in temporary accommodation (DLUHC)
      Numbers on social housing waiting lists (DLUHC)
    #}
    {% set chart_data = dataset.dwelling_stock.dwelling_stock(geo) %}
    {% set chart_min = chart_data | min | round(-3, 'floor') %}
    {% set chart_max = chart_data | getattr('Owned Outright') | max | round(-4, 'ceiling') %}
    {% if chart_data | length > 0 %}
      {% comp 'layout.wrapper', { width: 'max(20em, 70%)' } %}
        {{ comp.oi.chart.line({
          config: {
            legend: { 
              show: true
            },
            data: chart_data,
            padding: { bottom: 20, left: 20 },
            axis: {
              x: {
                title: {
                  label: "Year"
                },
                tick: { spacing: 1 }
              },
              y: {
                title: {
                  label: "Number of dwellings"
                },
                grid: {
                  show: true
                },
                tick: {
                  spacing: 20000
                },
                min: 0,
                max: chart_max
              }
            },
            series: [
              {
                title: "Owned Outright",
                x: "date",
                y: "Owned Outright",
                colour: "#3EB1C8",
                line: {
                  "stroke-dasharray": "5 10"
                }
              },
              {
                title: "Owned with Mortgage or Loan",
                x: "date",
                y: "Owned with Mortgage or Loan",
                colour: "#64A70B",
                line: {
                  "stroke-dasharray": "5 5"
                }
              },
              {
                title: "Private Rent",
                x: "date",
                y: "Private Rent",
                colour: "#8024c3",
                line: {
                  "stroke-dasharray": "0 10"
                }
              },
              {
                title: "Social Rent",
                x: "date",
                y: "Social Rent",
                colour: "#ce0058",
                line: {
                  "stroke-dasharray": "3 9"
                }
              }
            ]
          }
        })| safe }}
      {% endcomp %}
      {{comp.oi.chart.bar({
          config: {
            data: chart_data,
            stacked: true,
            legend: { show: true },
            percent: true,
            category: "date",
            series: [
              {
              "title": "Owned Outright",  
              "value": "Owned Outright",
              "colour": "#3EB1C8"
              },
              {
              "title": "Owned with Mortgage or Loan",  
              "value": "Owned with Mortgage or Loan",
              "colour": "#64A70B"
              },
              {
              "title": "Private Rent",  
              "value": "Private Rent",
              "colour": "#8024c3"
              },
              {
              "title": "Social Rent",  
              "value": "Social Rent",
              "colour": "#ce0058"
              }
              ],
            axis: {
              x: {
                grid: { "stroke-dasharray": "6 2", "stroke-width": 1 },
                ticks: [
                  { value: 20, label: '20' },
                  { value: 40, label: '40' },
                  { value: 60, label: '60' },
                  { value: 80, label: '80' },
                  { value: 100, label: '100' }
                  ]
                }
              } 
            }
          }) | safe
        }}
    {% else %}
      <p>No data available at this level.</p>
    {% endif %}
  {% endcomp %}


{% endcomp%}
{# end of tab set #}



<h3>Demographic breakdown</h3>

{% comp 'layout.tab.set' %}
  {% comp 'layout.tab.panel', { label: 'Age', id: 'age' } %}
    <h3>People living in households below average income by age category</h3>
    {% comp 'collapse', { heading: "What's on this chart?"} %}
      <p>This chart shows the the poverty rates by by age category in {{ this_place.title }}. 
        The threshold for low income poverty is households below 60% of median net household income (after housing costs) in latest prices. 
      </p>
      <h4>Dataset</h4> {{ comp.sourcelink({dataset: "hbai", view: "by_age_category"}) | safe }}
    {% endcomp %}
    {% set chart_data = dataset.hbai.low_income_by_age_category(geo) %}
    {% if chart_data| length > 0 %}
      {% comp 'layout.wrapper', { width: 'max(20em, 70%)' } %}
        {{ comp.oi.chart.line({
          config: {
            legend: { 
              show: true
            },
            data: chart_data,
            padding: { bottom: 20, left: 20 },
            axis: {
              x: {
                title: {
                  label: "Year"
                },
                ticks: [
                { value: "0", label: "1994-95 - 1996-97", tickSize: 8 },
                { value: "8", label: "2002-03 - 2004-05", tickSize: 8 },
                { value: "16", label: "2009-10 - 2011-12", tickSize: 8 },
                { value: "24", label: "2017-18 - 2019-20", tickSize: 8 }
                ]
              },
              y: {
                title: {
                  label: "Low income poverty rate (%)"
                },
                grid: {
                  show: true
                },
                tick: {
                  spacing: 5
                },
                min: 0,
                max: 20
              }
            },
            series: [
              {
                title: "Child",
                x: "date",
                y: "Child",
                colour: "#3EB1C8",
                line: {
                  "stroke-dasharray": "0 10"
                }
              },
              {
                title: "Working Age",
                x: "date",
                y: "Working-Age",
                colour: "#13242F",
                line: {
                  "stroke-dasharray": "5 10"
                }
              },
              {
                title: "Pensioner",
                x: "date",
                y: "Pensioner",
                colour: "#ce0058",
                line: {
                  "stroke-dasharray": "5 15"
                }
              }
            ]
          }
        })| safe }}
      {% endcomp %}
    {% else %}
      <p>No data available at this level.</p>
    {% endif %}
  {% endcomp %}

  
  {% comp 'layout.tab.panel', { label: 'Council tax support', id: 'council-tax-support' } %}
    <h3>Council tax support</h3>
    {% comp 'collapse', { heading: "What's on this chart?"} %}
      <p>This chart shows the number of people claiming council tax support in {{ this_place.title }}.</p>
      <h4>Dataset</h4> {{ comp.sourcelink({dataset: "council-tax-support", view: "council-tax-support"}) | safe }}
    {% endcomp %}
    {% set chart_data = data.spotlight.housing.time_series.council_tax(geo) %}
    {% if chart_data.rows | length > 0 %}
      {% comp 'layout.wrapper', { width: 'max(20em, 70%)' } %}
        {% set max = [
          chart_data.rows | getattr('working_age') | max,
          chart_data.rows | getattr('pensioners') | max
        ] | max %}

        {# @TODO figure out why this isnt working #}
        {{ comp.oi.chart.line({ 
          config: {
            legend: { 
              show: true
            },
            data: chart_data.rows,
            axis: {
              x: {
                title: {
                  label: "Year"
                }
              },
              y: {
                title: {
                  label: "Number of people"
                },
                grid: {
                  show: true
                },
                tick: {
                  spacing: max | sensible_tick_size
                },
                min: 0
              }
            },
            series: [
              {
                title: "Working-age",
                x: "date",
                y: "working_age",
                colour: "#13242F",
                line: {
                  "stroke-dasharray": "5 10"
                }
              },
              {
                title: "Pensioners",
                x: "date",
                y: "pensioners",
                colour: "#ce0058",
                line: {
                  "stroke-dasharray": "2 5"
                }
              }
            ]
          }
        }) | safe }}
      {% endcomp %}
    {% else %}
      <p> No data available at this level.</p>
    {% endif %}
  {% endcomp %}

{% endcomp %}
{# end of tab set #}




{{ top_trump_table(
  name="spotlight statistics",
  style="top-trump-table top-trump-invert",
  columns= [
      {
        name: 'Median house price (£)', 
        data: house_prices, 
        simple_data: null
      },
      {
        name: 'Number of working-age people claiming council tax support', 
        data: ct_working_age, 
        simple_data: ct_working_age_ratio
      },
      {
        name: 'Number of pensioners claiming council tax support', 
        data: ct_pensioners, 
        simple_data: ct_pensioners_ratio
      },
      {
        name: 'Households assessed as homeless', 
        data: homeless, 
        simple_data: homeless_ratio
      },
      {
        name: 'Number of people with support with mortgage interest', 
        data: smi_loans_in_payment_households, 
        simple_data: null
      },
      {
        name: 'Percentage of households receiving housing benefit', 
        data: housing_benefit_percent, 
        simple_data: housing_benefit_percent/100
      }
      ]
  ) 
}}
