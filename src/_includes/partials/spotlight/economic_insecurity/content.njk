{% set place_headlines = headlines.economic_insecurity.getInfographicValuesForPlace(geography) %}
{% set place_children = place[geography].relations.children %}
{% set place_and_children = [ geography, place_children ] | flat %}

<h3>Key indicators</h3>

<p>The following analysis reflects the experience across the population of {{ this_place.title }}.</p>

{% comp 'layout.tab.set' %}
{#------------------------------------------------------------------------
      ECONOMIC ACTIVITY
   -------------------------------------------------------------------------#}
{% comp 'layout.tab.panel', { label: 'Economic Activity', id: 'economic-activity' } %}
{% set chart_data = dataset
  .labour_market
  .get_economic_activity_for_place(geography) %}
{% if chart_data | length > 0 %}
  {{ comp.oi.chart.line({
    config: {
      data: chart_data,
      legend: { show: true },
      axis: {
        x: { title: { label: "Year" }, grid: { show: true } },
        y: { title: { label: "% of population" }, grid: { show: true }, tick: { spacing: 5 }, min: 0 }
      },
      series: [
        {
          x: "date", y: "Unemployment rate - aged 16-64",
          title: "Unemployment rate", line: { 'stroke-width': 5 }, points: { size: 10 }
        },
        {
          x: "date", y: "% who are economically inactive - aged 16-64",
          title: "Economic inactivity rate", line: { 'stroke-width': 5 }, points: { size: 10 }
        }
      ]
    }
  }) | safe }}
{% else %}
  <p>No data available at this level</p>
{% endif %}

{% endcomp %}

{% comp 'layout.tab.panel', { label: 'Fuel poverty', id: 'fuel-poverty' } %}
{% set fp_this = dataset.fuel_poverty.get_fuel_poverty([geography])[0] %}
{% set range = dataset.fuel_poverty.range() %}
{% set fp_all = dataset.fuel_poverty.get_fuel_poverty(place_and_children) %}

{% if fp_this | length > 0 %}
  <p>{{ this_place.title }}
  has {{ fp_this["Number of households in fuel poverty"] }}
  of {{ fp_this['Number of households'] }} households in fuel poverty.
{% endif %}

{% if fp_all.length > 0 %}
{{ comp.oi.map.svg({
  config: {
    data: fp_all,
    geojson: { data: place[geography].map, key: 'ons_code' },
    background: {
      geojson: 'map.england', colour: 'silver' },
    columns: [
      { name: 'tooltip', template: "{{ geography_name}}\n\n{{ Proportion of households fuel poor (%) | toFixed(1) }}% of households are fuel poor" }
    ],
    value: 'Proportion of households fuel poor (%)',
    scale: 'Viridis',
    min: range.min,
    max: range.max,
    legend: {
      position: 'top right',
      items: [
        { value: range.max, label: range.max + '% (highest)' },
        { value: (range.max + range.min) / 2, label: (range.max + range.min) / 2 + '%' },
        { value: range.min, label: range.min + '% (lowest)' }
      ]
    },
    key: 'geography_code',
    tooltip: 'tooltip'
  }
}) | safe }}
{% endif %}

{% endcomp %}

{% comp 'layout.tab.panel', { label: 'Weekly earning', id: 'weekly-earning' } %}
{{ dataset.ashe.weekly_earnings(place_and_children) | fake_csv | DEBUG | safe }}
{% endcomp %}

{% comp 'layout.tab.panel', { label: 'Savings and investments', id: 'savings-investments' } %}
{% set chart_data = dataset
  .hbai
  .get_savings_and_investments_for_place(geography) %}
{% if chart_data | length > 0 %}

  <a href="https://github.com/open-innovations/jrf-insight/blob/main/data/hbai/Savings%20and%20Investments%20of%20Adults%20in%20the%20Family%20of%20the%20Individual.csv">Savings and Investments</a>
  <p style="text-align: center;">Savings and investments of adults in the family for low income households</p>
  {{ comp.oi.chart.line({
    config: {
      legend: { show: true },
      data: chart_data,
      axis: {
        x: { title: { label: "Year" } },
        y: {
          title: { label: "Percent of population" }, grid: { show: true },
          tick: { spacing: 5 }, min: 0, max: 20
        }
      },
      series: [
        {
          title: "No savings", x: "date", y: "No savings",
          line: { 'stroke-width': 5 }, points: { size: 10 }
        },
        {
          title: "Less than £1,500",
          x: "date",
          y: "Less than £1,500",
          line: { 'stroke-width': 5 }, points: { size: 10 }
        },
        {
          title: "£1,500 but less than £3,000",
          x: "date",
          y: "£1,500 but less than £3,000",
          line: { 'stroke-width': 5 }, points: { size: 10 }
        },
        {
          title: "£3,000 but less than £8,000",
          x: "date",
          y: "£3,000 but less than £8,000",
          line: { 'stroke-width': 5 }, points: { size: 10 }
        },
        {
          title: "£8,000 but less than £10,000",
          x: "date",
          y: "£8,000 but less than £10,000",
          line: { 'stroke-width': 5 }, points: { size: 10 }
        }
      ]
    }
  }) | safe }}
{% else %}
  <p>No data available at this level</p>
{% endif %}
{% endcomp %}

{% comp 'layout.tab.panel', { label: 'Poverty index model', id: 'poverty-index-model' } %}
{% set model_data = data.model.econonmic_insecurity(place[geography].relations.children) %}
<h3>Visualisation</h3>
<p>This map shows the average scores when different statistics contirbuting to economic insecurity are normalised in the range 0-1 and averaged.
  A score of 0 corresponds to something less likely to cause poverty (e.g. extremely low rate
  of unemployment).</p>
  <p>
  The highest and lowest values will score 1 and 0, respectively, and everything else will fall 
  somewhere in between. We do this for 6 metrics - these are: economic inactivity, unemployment, mean weekly wage, median weekly wage, 
  claimants as a proportion of residents aged 16-64 and proportion of households that are fuel poor.
  This is a proof of concept. You can see the code and read more about the logic to create these stats <a href="https://github.com/open-innovations/jrf-insight/blob/main/playground/modelling/economic_insecurity.ipynb">here.</a>
  </p>
  <h3>Interpretation</h3>
  <p> In the context of this model, a value closer to 1 indicates that a given place tends to rank higher relative to other places in metrics that
    we have identified as contributing to economic insecurity. This does not necessarily mean that you are more liekly to experience poverty in those
    places, however. 
    </p>
{# {% if model_data | length > 0 %}
  <p>{{ this_place.title }}
  has {{ fp_this["Number of households in fuel poverty"] }}
  of {{ fp_this['Number of households'] }} households in fuel poverty.
{% endif %} #}

{% if model_data | length > 0 %}
{{ comp.oi.map.svg({
  config: {
    data: model_data.rows,
    geojson: { data: place[geography].map, key: 'ons_code' },
    background: {
      geojson: 'map.england', colour: 'silver' },
    columns: [
      { name: 'tooltip', template: "{{ geography_name }}\n\n{{ mean_normalised_score | toFixed(3) }}" }
    ],
    value: 'mean_normalised_score',
    scale: 'Viridis',
    min: 0,
    max: 1,
    legend: {
      position: 'top right',
      items: [
        { value: 0, label: 0 },
        { value: 0.5, label: 0.5 },
        { value: 1, label: 1 }
      ]
    },
    key: 'geography_code',
    tooltip: 'tooltip'
  }
}) | safe }}
{% endif %}

{% endcomp %}

{% endcomp %}

<h3>Demographic breakdown</h3>

<p>
  Poverty can disproportionately affect certain groups.
  This section presents analysis of {{ title }} with a focus on demographics.
</p>

{% comp 'layout.tab.set' %}
{% comp 'layout.tab.panel', { label: 'Gender' } %}
    Pay gap / % jobs less than living wage
{% endcomp %}
{% comp 'layout.tab.panel', {label: 'Ethnicity'} %}
{% endcomp %}
{% comp 'layout.tab.panel', {label: 'Single parents'} %}
{% endcomp %}
{% comp 'layout.tab.panel', {label: 'Carers'} %}
{% endcomp %}
{% endcomp %}

<p>
See also https://www.jrf.org.uk/report/economic-security-foundation-dignity-opportunity-and-hope-age-uncertainty
</p>


{% set savings = this_place_data['households_low_income_no_savings'] %}
{% set imd_average_score = this_place_data['imd_average_score'] %}
{% set median_weekly_wage = this_place_data['median_weekly_wage'] %}
{% set mean_weekly_wage = this_place_data['mean_weekly_wage'] %}
{% set fuel_poverty = this_place_data['Proportion of households fuel poor (%)'] %}

{{ top_trump_table(
  name="spotlight statistics",
  style="top-trump-table top-trump-invert",
  columns= [
      {
        name: 'Low income households with no savings or investments', 
        data: savings, 
        simple_data: null
      },
      {
        name: 'IMD average score', 
        data: imd_average_score, 
        simple_data: null
      },
      {
        name: 'Claimants as a proportion of residents aged 16-64 (UC & JSA)', 
        data: place_headlines.percentage_benefits_claimants, 
        simple_data: null
      },
      {
        name: 'Mean weekly wage (£)', 
        data: mean_weekly_wage, 
        simple_data: null
      },
      {
        name: 'Median weekly wage (£)', 
        data: median_weekly_wage, 
        simple_data: null
      }
      ]
  ) 
}}

{# {% comp 'layout.two_column' %}
    {{ comp.info.headline({
        number: savings,
        display: savings,
        description: 'Number of households with no savings or investments'
        }) | safe }}
    {{ comp.info.headline({
        number: imd_average_score,
        display: imd_average_score,
        description: 'IMD - average score'
        }) | safe }}
    {{ comp.info.headline({
        number: claimants,
        display: claimants,
        description: 'Claimants as a percentage of residents aged 16-64 (JSA and UC)'
        }) | safe }}
{% endcomp %} #}


<ul>
  <li>
    <a href="https://github.com/open-innovations/jrf-insight/tree/main/data/imd">IMD</a>
  </li>
</ul>