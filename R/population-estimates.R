#population estimates


# urls --------------------------------------------------------------------


url <- list(
  lad21 = "https://www.nomisweb.co.uk/api/v01/dataset/NM_2002_1.data.csv?geography=2013265921...2013265932,1937768449...1937768456,1811939329...1811939332,1811939334...1811939336,1811939338...1811939428,1811939436...1811939442,1811939768,1811939769,1811939443...1811939497,1811939499...1811939501,1811939503,1811939505...1811939507,1811939509...1811939517,1811939519,1811939520,1811939524...1811939570,1811939575...1811939599,1811939601...1811939628,1811939630...1811939634,1811939636...1811939647,1811939649,1811939655...1811939664,1811939667...1811939680,1811939682,1811939683,1811939685,1811939687...1811939704,1811939707,1811939708,1811939710,1811939712...1811939717,1811939719,1811939720,1811939722...1811939730,1811939757...1811939767,1807745025...1807745028,1807745030...1807745032,1807745034...1807745083,1807745085,1807745282,1807745283,1807745086...1807745155,1807745157...1807745164,1807745166...1807745170,1807745172...1807745177,1807745179...1807745194,1807745196,1807745197,1807745199,1807745201...1807745218,1807745221,1807745222,1807745224,1807745226...1807745231,1807745233,1807745234,1807745236...1807745244,1807745271...1807745281,1853882369...1853882372,1853882374...1853882379&date=latest&gender=0&c_age=200&measures=20100&uid=0xce1485b8af597e9021c978a63225cd5b792607df",
  wd19 = 'https://www.nomisweb.co.uk/api/v01/dataset/NM_2010_1.data.csv?geography=1656754822...1656754841,1656753597...1656753659,1656753516...1656753526,1656754306...1656754325,1656753660...1656753725,1656756726...1656756749,1656751170...1656751195,1656750877...1656750897,1656753863,1656755763...1656755788,1656750898...1656750960,1656755835...1656755851,1656751217...1656751237,1656753263...1656753314,1656756498...1656756542,1656751196...1656751216,1656755358...1656755379,1656756024...1656756046,1656751588...1656751600,1656757229...1656757241,1656756837...1656756853,1656751601...1656751630,1656755817...1656755834,1656750564...1656750600,1656755683...1656755714,1656750601...1656750746,1656752168...1656752239,1656754105...1656754131,1656752240...1656752257,1656753253,1656753254,1656756482...1656756497,1656756302...1656756327,1656752258...1656752271,1656754637...1656754659,1656752272...1656752296,1656754385...1656754408,1656755269...1656755283,1656750747...1656750776,1656750793...1656750814,1656750777...1656750792,1656750815...1656750836,1656751238...1656751263,1656755852...1656755872,1656751264...1656751295,1656754734...1656754754,1656752522...1656752525,1656754169...1656754176,1656755112...1656755118,1656754177...1656754193,1656755641...1656755680,1656756645...1656756660,1656752526...1656752545,1656756661...1656756680,1656754477...1656754495,1656750837...1656750857,1656755072...1656755092,1656750858...1656750876,1656753512,1656753513,1656755195...1656755222,1656751084...1656751148,1656753258...1656753262,1656755715...1656755741,1656755873,1656755874,1656756936,1656756937,1656757130,1656757131,1656751149...1656751169,1656751296...1656751312,1656754842...1656754862,1656756559...1656756578,1656756921...1656756935,1656751631...1656751648,1656753243...1656753247,1656756285...1656756301,1656751649...1656751692,1656754948...1656754994,1656756342...1656756365,1656753402...1656753416,1656752297...1656752312,1656754132,1656754133,1656752313...1656752340,1656756266...1656756284,1656752341...1656752372,1656754513...1656754550,1656752373...1656752382,1656754134...1656754148,1656754326...1656754362,1656755122...1656755132,1656752383...1656752426,1656754571...1656754600,1656754149...1656754168,1656754687...1656754698,1656753580...1656753595,1656752471...1656752479,1656755099...1656755111,1656752480...1656752494,1656753251,1656753252,1656753417...1656753449,1656752495...1656752521,1656754461...1656754476,1656755017...1656755039,1656752546...1656752570,1656754898...1656754917,1656754194...1656754212,1656753450...1656753485,1656754496...1656754512,1656755875...1656755878,1656754213...1656754237,1656753986...1656754034,1656757246...1656757249,1656753050...1656753105,1656753848...1656753854,1656753315...1656753351,1656754418...1656754447,1656752650...1656752685,1656754995...1656755016,1656755742...1656755762,1656752686...1656752710,1656754863...1656754885,1656752711...1656752747,1656752882...1656752915,1656753544...1656753556,1656755096...1656755098,1656754601...1656754636,1656756904...1656756920,1656755451...1656755519,1656750961...1656751083,1656754276...1656754305,1656752969...1656753049,1656754886...1656754897,1656753352...1656753401,1656757132...1656757139,1656751333...1656751351,1656755143...1656755164,1656751352...1656751388,1656751574...1656751587,1656755881...1656755894,1656754035...1656754058,1656755589...1656755640,1656751714...1656751729,1656754788...1656754806,1656757250...1656757256,1656751730...1656751782,1656755165...1656755181,1656751783...1656751812,1656753514,1656753515,1656751813...1656751840,1656755182...1656755194,1656756234...1656756265,1656754363...1656754384,1656753570...1656753579,1656751967...1656752013,1656753864,1656757270...1656757276,1656756466...1656756481,1656752014...1656752056,1656753596,1656752057...1656752068,1656753865,1656753973...1656753985,1656755380...1656755407,1656754660...1656754686,1656752427...1656752470,1656756610...1656756644,1656756138...1656756169,1656757190...1656757202,1656756170...1656756193,1656757140,1656757141,1656756854...1656756877,1656752748...1656752763,1656757023...1656757051,1656756878...1656756903,1656757052...1656757094,1656750162...1656750179,1656753855...1656753862,1656753915...1656753935,1656750241...1656750275,1656750357...1656750372,1656753936...1656753953,1656750389...1656750427,1656750448...1656750467,1656755428...1656755450,1656753866...1656753885,1656750524...1656750563,1656750081...1656750118,1656755550...1656755566,1656750119...1656750161,1656755789...1656755816,1656750180...1656750240,1656750276...1656750356,1656750373...1656750388,1656750428...1656750447,1656755567...1656755588,1656750468...1656750523,1656751411...1656751428,1656751470...1656751490,1656753204...1656753242,1656751389...1656751410,1656753954...1656753972,1656751491...1656751504,1656751429...1656751444,1656753886...1656753900,1656751505...1656751520,1656756421...1656756444,1656756783...1656756801,1656751445...1656751469,1656754755...1656754787,1656751521...1656751545,1656754936...1656754947,1656751546...1656751573,1656755895...1656755903,1656755534...1656755549,1656755904...1656755986,1656751861...1656751889,1656756579...1656756609,1656755520...1656755533,1656751890...1656751921,1656753901...1656753911,1656751922...1656751966,1656753509...1656753511,1656753557...1656753569,1656756386...1656756392,1656757216...1656757228,1656755329...1656755344,1656756047...1656756085,1656754807...1656754821,1656757242...1656757245,1656757279,1656757280,1656756681...1656756700,1656757144...1656757160,1656752069...1656752109,1656753255...1656753257,1656752110...1656752124,1656754409...1656754417,1656755879,1656755880,1656754448...1656754460,1656754059...1656754082,1656752125...1656752147,1656754083...1656754104,1656757277,1656757278,1656752148...1656752167,1656755257...1656755268,1656755681,1656755682,1656757257,1656757258,1656752571...1656752594,1656754238...1656754246,1656756008...1656756017,1656757142,1656757143,1656754247...1656754252,1656756018...1656756023,1656757259...1656757269,1656757281,1656752595...1656752615,1656753912...1656753914,1656755119...1656755121,1656755408...1656755423,1656752764...1656752819,1656757161...1656757189,1656752820...1656752832,1656756328...1656756341,1656752833...1656752881,1656755133...1656755142,1656752916...1656752929,1656754253...1656754275,1656755987...1656756007,1656757203...1656757215,1656756116...1656756137,1656752930...1656752968,1656756750...1656756782,1656756938...1656756970,1656755223...1656755256,1656753726...1656753847,1656755424...1656755427,1656754699...1656754733,1656751313...1656751332,1656756393...1656756420,1656753527...1656753543,1656755093...1656755095,1656756543...1656756558,1656753106...1656753203,1656756086...1656756115,1656755345...1656755357,1656751693...1656751713,1656753248...1656753250,1656756701...1656756725,1656754551...1656754570,1656756194...1656756233,1656754918...1656754935,1656756971...1656757022,1656751841...1656751860,1656755040...1656755071,1656756445...1656756465,1656755284...1656755328,1656756366...1656756385,1656752616...1656752649,1656753486...1656753508,1656756802...1656756836,1656757095...1656757129,1656758076...1656758086,1656757282...1656757384,1656758008...1656758013,1656757385...1656757463,1656758099...1656758105,1656758131,1656757464...1656757500,1656757998...1656758007,1656757501...1656757571,1656757990,1656757991,1656757572...1656757656,1656758041...1656758053,1656758132,1656758133,1656757657...1656757712,1656758097,1656758098,1656757713...1656757726,1656758054...1656758075,1656757727...1656757759,1656758122...1656758130,1656757760...1656757794,1656757993...1656757996,1656757795...1656757813,1656758027...1656758030,1656757965...1656757986,1656757997,1656758106...1656758111,1656757814...1656757852,1656757987...1656757989,1656758112...1656758121,1656757853...1656757862,1656757992,1656757863...1656757882,1656758014...1656758026,1656757883...1656757888,1656758031...1656758040,1656757889...1656757902,1656758087...1656758096,1656757903...1656757964&date=latest&gender=0&c_age=200&measures=20100&uid=0xce1485b8af597e9021c978a63225cd5b792607df'
)


# build -------------------------------------------------------------------

lad <- readr::read_csv("data-raw/population-estimates/lad.csv")

lad <- lad |>
  setNames(tolower(names(lad))) |>
  dplyr::mutate(variable_code = 'n_persons',
                variable_name = 'Number of persons') |>
  dplyr::mutate(geography_type = dplyr::case_when(
    substr(geography_code, 1, 3) == "E12" ~ "rgn22",
    substr(geography_code, 1, 3) == "E11" ~ "mcty13",
    substr(geography_code, 1, 3) %in% paste0('E0', 6:9) ~ "lad22",
    substr(geography_code, 1, 3) == "E10" ~ 'cty22',
    substr(geography_code, 1, 3) == 'E47' ~ 'cauth22'
  )) |>
  dplyr::select(date,
                geography_code, geography_name, geography_type,
                gender_code, gender_name,
                age_code = c_age_code, age_name = c_age_name,
                variable_code, variable_name,
                value = obs_value)

wd <- readr::read_csv("data-raw/population-estimates/wd19.csv")

wd <- wd |>
  setNames(tolower(names(wd))) |>
  dplyr::mutate(variable_code = 'n_persons',
                variable_name = 'Number of persons') |>
  dplyr::mutate(geography_type = dplyr::case_when(
    substr(geography_code, 1, 3) == "E05" ~ "wd22"
  )) |>
  dplyr::select(date,
                geography_code, geography_name, geography_type,
                gender_code, gender_name,
                age_code = c_age_code, age_name = c_age_name,
                variable_code, variable_name,
                value = obs_value)

grp_by <- names(lad)[!names(lad) %in% c("value", "geography_code", "geography_name", "geography_type")]
panrgn <- lad |>
  dplyr::filter(geography_code %in% paste0('E1200000', 1:3)) |>
  dplyr::group_by(dplyr::across(dplyr::all_of(grp_by))) |>
  dplyr::summarise(geography_code = "E12999901",
                   geography_name = "The North",
                   geography_type = "panrgn22",
                   value = sum(value))

population_estimates <- dplyr::bind_rows(
  panrgn, lad, wd
) |>
  dplyr::filter(!is.na(geography_type),
                geography_type != "mcty13") |>
  dplyr::select(date,
                geography_code, geography_name, geography_type,
                gender_code, gender_name,
                age_code, age_name,
                variable_code, variable_name,
                value) |>
  readr::write_csv("data/population-estimates/population-estimates.csv")



